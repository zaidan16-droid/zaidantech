!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Human Tracker with Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: Arial; margin: 10px; }
    #map { height: 70vh; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>🚗 Human Tracker (Dengan Login)</h2>

 
  <input type="text" name="name" placeholder="Nama" required />
  <input type="email" name="email" placeholder="Email" required />
  <input type="number" name="amount" value="15000" hidden />
  <button type="submit">Langganan Sekarang</button>
</form>


  <div id="map"></div>

  <button onclick="shareLocation()">📍 Share My Location</button>
  
   <h2>Pembayaran Tripay</h2>
  <button onclick="bayar()">Bayar Sekarang</button>
  
  


  <!-- Leaflet & Firebase -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
   <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAwdf695f530_Shjn2L_dv5MpapqHuYycI",
      authDomain: "humantracker-8c75b.firebaseapp.com",
      databaseURL: "https://humantracker-8c75b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "humantracker-8c75b",
      storageBucket: "humantracker-8c75b.appspot.com",
      messagingSenderId: "710042422665",
      appId: "1:710042422665:web:6f31e2dafc6fe2f003a558"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    

    let currentUID = null;
    
 
    // Inisialisasi peta
    const map = L.map("map").setView([-7.755499, 110.29975], 17);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
   L.marker([-7.755499, 110.29975]).addTo(map)
      .bindPopup("Lokasi Awal")
      .openPopup();
    const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/743/743007.png',
      iconSize: [30, 30]
    });

    const markers = {};

    // Baca lokasi semua user
    db.ref("users").on("value", snap => {
      const data = snap.val();
      for (const uid in data) {
        const user = data[uid];
        const latlng = [user.lat, user.lon];
        const info = `<b>${user.name || "Anonim"}</b>`;

        if (markers[uid]) {
          markers[uid].setLatLng(latlng).setPopupContent(info);
        } else {
          markers[uid] = L.marker(latlng, { icon: carIcon }).addTo(map).bindPopup(info);
        }
      }
    });

    // Pantau login/logout
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUID = user.uid;
        document.getElementById("status").innerText = "Login sebagai: " + user.email;
      } else {
        currentUID = null;
        document.getElementById("status").innerText = "Belum login";
      }
    });

    // Login
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(e => alert("Login gagal: " + e.message));
    }

    // Logout
    function logout() {
      auth.signOut();
    }

    // Share lokasi
    function shareLocation() {
      if (!currentUID) return alert("Silakan login dulu!");
      navigator.geolocation.getCurrentPosition(pos => {
        db.ref("users/" + currentUID).set({
          name: auth.currentUser.email,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude
        });
        alert("Lokasi dikirim.");
      }, err => {
        alert("Gagal ambil lokasi: " + err.message);
      });
    }
     
    
    

  </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Human Tracker + Tripay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: Arial; margin: 10px; }
    #map { height: 70vh; margin-top: 10px; }
  </style>
</head>
<body>

<h2>🚗 Human Tracker (Login + Tripay)</h2>

<div>
  <input id="name" type="text" placeholder="Nama" required />
  <input id="email" type="email" placeholder="Email" required />
  <button onclick="bayar()">💳 Langganan Sekarang</button>
</div>

<div id="map"></div>
<button onclick="shareLocation()">📍 Share My Location</button>

<h3 id="status">Belum login</h3>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "API_FIREBASE",
  authDomain: "humantracker-8c75b.firebaseapp.com",
  databaseURL: "https://humantracker-8c75b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "humantracker-8c75b",
  storageBucket: "humantracker-8c75b.appspot.com",
  messagingSenderId: "710042422665",
  appId: "APP_ID"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
let currentUID = null;

// Peta
const map = L.map("map").setView([-7.755499, 110.29975], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const carIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/743/743007.png', iconSize: [30, 30] });
const markers = {};

db.ref("users").on("value", snap => {
  const data = snap.val();
  for (const uid in data) {
    const user = data[uid];
    const latlng = [user.lat, user.lon];
    const info = `<b>${user.name || "Anonim"}</b>`;
    if (markers[uid]) {
      markers[uid].setLatLng(latlng).setPopupContent(info);
    } else {
      markers[uid] = L.marker(latlng, { icon: carIcon }).addTo(map).bindPopup(info);
    }
  }
});

auth.onAuthStateChanged(user => {
  if (user) {
    currentUID = user.uid;
    document.getElementById("status").innerText = "Login sebagai: " + user.email;
  } else {
    currentUID = null;
    document.getElementById("status").innerText = "Belum login";
  }
});

function shareLocation() {
  if (!currentUID) return alert("Silakan login dulu!");
  navigator.geolocation.getCurrentPosition(pos => {
    db.ref("users/" + currentUID).set({
      name: auth.currentUser.email,
      lat: pos.coords.latitude,
      lon: pos.coords.longitude
    });
    alert("Lokasi dikirim.");
  }, err => alert("Gagal ambil lokasi: " + err.message));
}
async function bayar() {
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const amount = 10000;

  if (!name || !email) {
    return alert("Nama dan email harus diisi!");
  }

  try {
   const res = await fetch("/create-transaction", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
});

const text = await res.text(); // ambil mentahan
try {
  const data = JSON.parse(text); // coba parse ke JSON
  console.log("Hasil:", data);
} catch (e) {
  console.error("Bukan JSON, ini isinya:", text); // debug kalau salah
}

</script>
</body>
</html>

